<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/super_admin_dashboard.css">
    <link rel="stylesheet" href="../static/css/w3.css">
    <link rel="icon" type="image/x-icon" href="../static/images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Dashboard</title>
</head>

<body>


    
    <!-- CONTAINER -->
    <div class="container">
        <!-- SIDEBAR -->
        <!-- SIDEBAR -->
        <!-- SIDEBAR -->
        <aside class="w3-sidebar w3-bar-block w3-card-2 width" style="width:250px">
            <!-- LOGO -->
            <div class="w3-center w3-bar-item logo">
                <img src="../static/images/logo.jpg" alt="Logo" class="logo" style="width: 90px; height: 100px;">
            </div>

            <!-- MAIN TITLE (DASHBOARD)-->
            <div class="w3-margin w3-margin-top main-title">
                <img src="../static/images/dashboard.png" alt="Dashboard" class="nav-icon">
                <span>LAUNDRYLINK</span>
            </div>

            <!-- MAIN NAVIGATION -->
            <div class="w3-bar-block">
                <a href="{{ url_for('super_admin_dashboard') }}" class="w3-bar-item w3-button w3-padding active"><i
                        class="fa fa-tachometer-alt fa-fw"></i> Dashboard</a>
                <a href="{{ url_for('laundry_shops') }}" class="w3-bar-item w3-button w3-padding"><i
                        class="fa fa-store fa-fw"></i> Laundry Shops</a>
                <a href="{{ url_for('device_monitoring') }}" class="w3-bar-item w3-button w3-padding"><i
                        class="fa fa-microchip fa-fw"></i> Device
                    Monitoring</a>
                <a href="{{ url_for('super_admin_reports') }}" class="w3-bar-item w3-button w3-padding"><i
                        class="fa fa-chart-line fa-fw"></i> Reports &
                    Analytics</a>
                <div class="logout-btn">
                    <a href="{{ url_for('logout') }}" class="w3-bar-item w3-button w3-padding"><i
                            class="fa fa-sign-out-alt fa-fw"></i> Logout</a>
                </div>
            </div>


        </aside>

        <!-- MAIN -->
        <main>
            <!-- HEADER -->
            <header>
                <div>
                    <h1 class="page-title">Dashboard</h1>
                    <div class="breadcrumb">Main / Dashboard</div>
                </div>
            </header>

            <!-- CONTAINER FOR THE MAIN CONTENT -->
            <div class="w3-container w3-padding w3-margin">
                <!-- DASHBOARD OVERVIEW -->
                <div class="w3-padding-top">
                    <!-- Calculate Active Counts -->
                    {% set ns = namespace(active_kiosks=0, active_esp32s=0) %}
                    {% for shop in shops %}
                    {% if shop.kiosk.status|lower in ['active', 'online'] %}
                    {% set ns.active_kiosks = ns.active_kiosks + 1 %}
                    {% endif %}

                    {% endfor %}

                    <!-- STATS CARDS -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Active Devices</h3>
                                <p class="stat-number">{{ ns.active_kiosks }}</p>
                                <p class="stat-detail">{{ ns.active_kiosks }} Kiosks</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-circle text-danger" style="color: #f44336;"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Inactive Devices</h3>
                                <p class="stat-number text-danger" style="color: #f44336;">{{ total_offline_devices }}
                                </p>
                                <p class="stat-detail">{{ offline_kiosk_count }}
                                    Kiosk</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Installed Shops</h3>
                                <p class="stat-number">{{ installed_shops_count }}</p>
                                <p class="stat-detail">with active devices</p>
                            </div>
                        </div>

                        <!-- <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Monthly Earnings</h3>
                                <p class="stat-number">â‚±{{ "%.2f"|format(monthly_earnings) }}</p>
                                <p class="stat-detail">This month's total</p>
                            </div>
                        </div> -->
                    </div>

                    <!-- MAIN CONTENT -->
                    <div class="dashboard-row full-row">
                        <!-- DEVICE MONITORING LOGS -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-microchip"></i> Device Monitoring Logs</h3>
                                <span class="card-badge" style="background-color: #e3f2fd; color: #122D69;">Live
                                    Status</span>
                            </div>
                            <div class="card-content">
                                <div class="logs-container" style="max-height: 380px; overflow-y: auto;">
                                    <table class="status-table">
                                        <thead>
                                            <tr>
                                                <th>Shop Name</th>
                                                <th>Device Type</th>
                                                <th style="text-align: center;">Status</th>
                                                <th style="text-align: right;">Last Seen</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for shop in shops %}
                                            <tr>
                                                <td style="font-weight: 500;">{{ shop.SHOP_NAME }}</td>
                                                <td><i class="fas fa-server"
                                                        style="color: #999; margin-right: 5px;"></i> Kiosk</td>
                                                <td style="text-align: center;">
                                                    {% if shop.kiosk.status == 'online' %}
                                                    <span class="status-badge status-online">Online</span>
                                                    {% else %}
                                                    <span class="status-badge status-offline">Offline</span>
                                                    {% endif %}
                                                </td>
                                                <td style="text-align: right; color: var(--text-light);">{{
                                                    shop.kiosk.last_seen }}</td>
                                            </tr>
                                            {% endfor %}
                                            {% if not shops %}
                                            <tr>
                                                <td colspan="4"
                                                    style="text-align: center; color: var(--text-light); padding: 20px;">
                                                    No devices found.</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="view-all">
                                    <a href="{{ url_for('device_monitoring') }}" class="view-all-link">View Full Device
                                        Report <i class="fas fa-arrow-right"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </main>
    </div>



    <!-- CALENDAR JAVASCRIPT -->
    <script>

        // CALENDAR
        let currentDate = new Date();
        let selectedDate = new Date();
        let datesWithOrders = new Set();
        let datesWithPickups = new Set();
        const orderStatusCounts = JSON.parse('{{ order_status_counts|tojson|safe }}');
        const orderTrend = JSON.parse('{{ order_trend|tojson|safe }}');

        document.addEventListener('DOMContentLoaded', function () {
            renderOrderCharts();
        });



        function renderOrderCharts() {
            if (typeof Chart === 'undefined') return;

            // Status doughnut with background ring and center text
            const centerText = {
                id: 'centerText',
                afterDraw(chart) {
                    const opts = chart.config.options.plugins.centerText || {};
                    const { text = '', subText = '' } = opts;
                    if (!text) return;
                    const { ctx, chartArea } = chart;
                    if (!chartArea) return;
                    const x = (chartArea.left + chartArea.right) / 2;
                    const y = (chartArea.top + chartArea.bottom) / 2;
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#122D69';
                    ctx.font = '700 18px Poppins, sans-serif';
                    ctx.fillText(text, x, y - (subText ? 6 : 0));
                    if (subText) {
                        ctx.fillStyle = '#6c757d';
                        ctx.font = '600 12px Poppins, sans-serif';
                        ctx.fillText(subText, x, y + 12);
                    }
                    ctx.restore();
                }
            };

            const statusLabels = Object.keys(orderStatusCounts || {});
            const statusValues = Object.values(orderStatusCounts || {});
            const statusColors = ['#28a745', '#9aa5b5', '#ffc107', '#dc3545'];
            const statusTotal = statusValues.reduce((a, b) => a + b, 0);

            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                // If no orders, show empty ring and legend with all zeros
                const showEmpty = statusTotal === 0;
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: showEmpty
                            ? [
                                {
                                    data: [1],
                                    backgroundColor: ['#e8edf5'],
                                    borderWidth: 0,
                                    hoverOffset: 0,
                                    weight: 1,
                                    cutout: '78%'
                                }
                            ]
                            : [
                                {
                                    data: [statusTotal],
                                    backgroundColor: ['#e8edf5'],
                                    borderWidth: 0,
                                    hoverOffset: 0,
                                    weight: 0.5,
                                    cutout: '40%'
                                },
                                {
                                    data: statusValues,
                                    backgroundColor: statusColors,
                                    borderWidth: 2,
                                    borderColor: '#ffffff',
                                    hoverOffset: 6,
                                    spacing: 2,
                                    weight: 1
                                }
                            ]
                    },
                    options: {
                        plugins: {
                            legend: { display: false }, // <-- Hide legend
                            centerText: { text: (statusTotal || 0).toString(), subText: 'Total' }
                        },
                        maintainAspectRatio: false,
                        cutout: '78%'
                    },
                    plugins: [centerText]
                });
            }

            // Trend bar (last 7 days)
            const trendLabels = (orderTrend && orderTrend.labels) || [];
            const trendValues = (orderTrend && orderTrend.counts) || [];
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx) {
                new Chart(trendCtx, {
                    type: 'bar',
                    data: {
                        labels: trendLabels,
                        datasets: [{
                            label: 'Orders',
                            data: trendValues,
                            backgroundColor: '#122D69',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                        plugins: { legend: { display: false } },
                        maintainAspectRatio: false
                    }
                });
            }
        }



        function toggleOrders() {
            const prioritySection = document.getElementById('priorityOrdersSection');
            const selfServiceSection = document.getElementById('selfServiceOrdersSection');
            const btnText = document.getElementById('toggleOrdersBtnText');
            const btnIcon = document.querySelector('#toggleOrdersBtn i.fas');
            if (prioritySection.style.display === 'none') {
                prioritySection.style.display = '';
                selfServiceSection.style.display = 'none';
                btnText.textContent = 'Self-service Orders';
                btnIcon.className = 'fas fa-user-cog';
            } else {
                prioritySection.style.display = 'none';
                selfServiceSection.style.display = '';
                btnText.textContent = 'Priority Orders';
                btnIcon.className = 'fas fa-list';
            }
        }
    </script>
</body>

</html>