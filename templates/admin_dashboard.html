<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/staff_dashboard.css">
    <link rel="stylesheet" href="../static/css/w3.css">
    <link rel="icon" type="image/x-icon" href="../static/images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Admin Dashboard</title>
</head>
<body>
    <!-- CONTAINER -->
    <div class="container">
        <!-- SIDEBAR -->
        <aside class="w3-sidebar w3-bar-block w3-card-2 width" style="width:250px">
            <!-- LOGO -->
            <div class="w3-center w3-bar-item logo">
                <img src="../static/images/logo.jpg" alt="Logo" class="logo" style="width: 90px; height: 100px;">
            </div>
            
            <!-- MAIN TITLE (DASHBOARD)-->
            <div class="w3-margin w3-margin-top main-title">
                <img src="../static/images/dashboard.png" alt="Dashboard" class="nav-icon">
                <span>Dashboard</span>
            </div>
            
            <!-- MAIN NAVIGATION PERO SIDEBAR GIHAPON NA SUD HA **BASTA MAO NANA -->
            <nav class="w3-container w3-padding w3-margin-top">
                <!-- MAIN -->
                <div class="section-title w3-padding w3-text-gray">Main</div>
                <!-- DASHBOARD, DETERGENT, CONDITIONER, SCANNER -->
                <ul class="w3-margin-left">
                    <li class="w3-padding w3-bar-item w3-button active">
                        <a href="{{ url_for('dashboard') }}">
                            <span>Dashboard</span>
                        </a>
                    </li>
                        
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('detergent_inventory') }}">
                            <span>Detergent</span>
                        </a>      
                    </li>
                    
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('fabric_conditioner') }}">
                            <span>Fabric Conditioner</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('scanner') }}">
                            <span>Scanner</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('customers') }}">
                            <span>Customers</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('orders') }}">
                            <span>Orders</span>
                        </a>
                    </li>
                </ul>
                <!-- REPORTS -->
                <div class="section-title w3-padding w3-text-gray">Reports</div>
                <ul class="w3-margin-left">
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('admin_order_report')}}">
                            <span>Order Reports</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('inventory_report') }}">
                            <span>Inventory Reports</span>
                        </a>
                    </li>
                    
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('income_statement') }}">
                            <span>Sales Report</span>
                        </a>
                    </li>
                    
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('customer_report') }}">
                            <span>Transaction Reports</span>
                        </a>
                    </li>
                </ul>
                <!-- LOGOUT -->
                <ul class="w3-margin-left w3-margin-top">
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('logout') }}">
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        
        <!-- MAIN -->
        <main>
            <!-- HEADER -->
            <header>
                <div>
                    <button class="w3-button w3-xlarge hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <h1 class="page-title">Dashboard</h1>
                    <div class="breadcrumb">Main / Dashboard</div>
                </div>
            </header>

            <!-- CONTAINER FOR THE MAIN CONTENT -->
            <div class="w3-container w3-padding w3-margin">
                <!-- DASHBOARD OVERVIEW -->
                <div class="w3-padding-top">
                    <!-- STATS CARDS -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-content">
                                <h3>List of Orders</h3>
                                <p class="stat-number">{{ total_orders }}</p>
                                <p class="stat-detail">{{ self_service_count }} Self-service • {{ drop_off_count }} Drop-off</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Today's Sales</h3>
                                <p class="stat-number">₱{{ "%.2f"|format(todays_sales) }}</p>
                                <p class="stat-detail">Total orders today: {{ total_orders }}</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Inventory Alerts</h3>
                                <p class="stat-number">{{ low_detergents|length + low_fabcons|length }}</p>
                                <p class="stat-detail">Low stock items</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Monthly Earnings</h3>
                                <p class="stat-number">₱{{ "%.2f"|format(monthly_earnings) }}</p>
                                <p class="stat-detail">This month's total</p>
                            </div>
                        </div>
                    </div>

                    <!-- MAIN CONTENT -->
                    <div class="dashboard-row full-row">
                        <!-- ORDERS STATISTICS -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-bar"></i> Orders Statistics</h3>
                                <div class="order-stats">
                                    <span class="order-count">{{ total_orders }}</span>
                                    <span class="order-label">Total Orders</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="orders-stats-list">
                                    <div class="stat-line">
                                        <span class="stat-label">Pending</span>
                                        <strong class="stat-value">{{ pending_count }}</strong>
                                    </div>
                                    <div class="stat-line">
                                        <span class="stat-label">Pick-up</span>
                                        <strong class="stat-value">{{ pickup_count }}</strong>
                                    </div>
                                    <div class="stat-line">
                                        <span class="stat-label">Completed</span>
                                        <strong class="stat-value">{{ completed_count }}</strong>
                                    </div>
                                    <div class="stat-line">
                                        <span class="stat-label">Self-service</span>
                                        <strong class="stat-value">{{ self_service_count }}</strong>
                                    </div>
                                    <div class="stat-line">
                                        <span class="stat-label">Drop-off</span>
                                        <strong class="stat-value">{{ drop_off_count }}</strong>
                                    </div>
                                </div>
                                <div class="orders-charts">
                                    <div class="chart-block large">
                                        <div class="chart-title"><i class="fas fa-circle-notch"></i> Status Breakdown</div>
                                        <canvas id="statusChart"></canvas>
                                    </div>
                                    <div class="chart-block large">
                                        <div class="chart-title"><i class="fas fa-chart-line"></i> Last 7 Days</div>
                                        <canvas id="trendChart"></canvas>
                                    </div>
                                </div>
                                <div class="view-all">
                                    <a href="{{ url_for('orders') }}" class="view-all-link">View All Orders <i class="fas fa-arrow-right"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-row secondary-row">
                        <!-- CALENDAR -->
                        <div class="dashboard-card calendar-card" style="margin-top: 30px;">
                            <div class="card-header">
                                <h3><i class="fas fa-calendar-alt"></i> Calendar</h3>
                                <span class="card-badge">2025-2040</span>
                            </div>
                            <div class="card-content">
                                <div class="calendar-container">
                                    <div class="calendar-header">
                                        <button class="calendar-nav-btn" onclick="previousMonth()">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <div class="current-month-year">
                                            <span id="currentMonth">January</span>
                                            <span id="currentYear">2025</span>
                                        </div>
                                        <button class="calendar-nav-btn" onclick="nextMonth()">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="calendar-weekdays">
                                        <div class="weekday">Sun</div>
                                        <div class="weekday">Mon</div>
                                        <div class="weekday">Tue</div>
                                        <div class="weekday">Wed</div>
                                        <div class="weekday">Thu</div>
                                        <div class="weekday">Fri</div>
                                        <div class="weekday">Sat</div>
                                    </div>
                                    <div class="calendar-days" id="calendarDays">
                                        <!-- I'M CRAVING JAVA CHIPS HAHAHHAHA BTW CONNECTED NIS JAVASCRIPT -->
                                    </div>
                                </div>
                                <div class="view-all">
                                    <a href="#" class="view-all-link" onclick="openCalendarModal()">View Full Calendar <i class="fas fa-arrow-right"></i></a>
                                </div>
                            </div>
                        </div>

                        <!-- INVENTORY ALERTS -->
                        <div class="dashboard-card inventory-alerts-card" style="margin-top: 30px;">
                            <div class="card-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Inventory Alerts</h3>
                                <span class="card-badge alert">{{ low_detergents|length + low_fabcons|length }}</span>
                            </div>
                            <div class="card-content">
                                <div class="inventory-details inventory-details-alone">
                                    {% if low_detergents %}
                                    <div class="inventory-item">
                                        <div class="item-header">
                                            <div class="item-icon detergent-icon">
                                                <i class="fas fa-soap"></i>
                                            </div>
                                            <div class="item-info">
                                                <h4>Detergent</h4>
                                                <span class="item-stock">{{ low_detergents|length }} item{% if low_detergents|length != 1 %}s{% endif %} low</span>
                                                <ul class="low-stock-list">
                                                    {% for item in low_detergents %}
                                                    <li>{{ item['DETERGENT_NAME'] }} ({{ item['QTY'] }} left)</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <div class="stock-indicator critical">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill critical" style="width: 25%"></div>
                                        </div>
                                    </div>

                                    <div class="view-all-inventory-btn-container">
                                        <a href="{{ url_for('detergent_inventory') }}" class="view-all-inventory-btn">View All Detergent Inventory</a>
                                    </div>
                                    {% endif %}

                                    {% if low_fabcons %}
                                    <div class="inventory-item">
                                        <div class="item-header">
                                            <div class="item-icon conditioner-icon">
                                                <i class="fas fa-tshirt"></i>
                                            </div>
                                            <div class="item-info">
                                                <h4>Fabric Conditioner</h4>
                                                <span class="item-stock">{{ low_fabcons|length }} item{% if low_fabcons|length != 1 %}s{% endif %} low</span>
                                                <ul class="low-stock-list">
                                                    {% for item in low_fabcons %}
                                                    <li>{{ item['FABCON_NAME'] }} ({{ item['QTY'] }} left)</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <div class="stock-indicator warning">
                                                <i class="fas fa-exclamation-circle"></i>
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill warning" style="width: 40%"></div>
                                        </div>
                                    </div>
                                    <div class="view-all-inventory-btn-container">
                                        <a href="{{ url_for('fabric_conditioner') }}" class="view-all-inventory-btn">View All Fabcon Inventory</a>
                                    </div>
                                    {% endif %}

                                    {% if not low_detergents and not low_fabcons %}
                                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                                        <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px; color: #28a745;"></i>
                                        <p>All inventory levels are healthy</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CALENDAR MODAL -->
    <div id="calendarModal" class="calendar-modal">
        <div class="calendar-modal-content">
            <div class="calendar-modal-header">
                <h2><i class="fas fa-calendar-alt"></i> Full Calendar</h2>
                <button class="modal-close-btn" onclick="closeCalendarModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="calendar-modal-body">
                <div class="full-calendar-container">
                    <div class="full-calendar-header">
                        <button class="full-calendar-nav-btn" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="full-current-month-year">
                            <span id="fullCurrentMonth">January</span>
                            <span id="fullCurrentYear">2025</span>
                        </div>
                        <button class="full-calendar-nav-btn" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="full-calendar-weekdays">
                        <div class="full-weekday">Sun</div>
                        <div class="full-weekday">Mon</div>
                        <div class="full-weekday">Tue</div>
                        <div class="full-weekday">Wed</div>
                        <div class="full-weekday">Thu</div>
                        <div class="full-weekday">Fri</div>
                        <div class="full-weekday">Sat</div>
                    </div>
                    <div class="full-calendar-days" id="fullCalendarDays">
                        <!-- DO NOT CHANGE THIS , CONNECTED NIS JAVASCRIPT -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DATE DETAILS MODAL -->
    <div id="dateDetailsModal" class="date-details-modal">
        <div class="date-details-modal-content">
            <div class="date-details-modal-header">
                <h2><i class="fas fa-calendar-day"></i> <span id="selectedDateTitle">January 15, 2025</span></h2>
                <button class="modal-close-btn" onclick="closeDateDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="date-details-modal-body">
                <div class="date-details-grid">
                    <!-- ORDERS FOR THE DAY -->
                    <div class="date-details-card">
                        <div class="details-card-header">
                            <h3><i class="fas fa-shopping-cart"></i> Orders for This Date</h3>
                            <span class="details-badge">0</span>
                        </div>
                        <div class="details-card-content">
                            <!-- Orders will be dynamically loaded here -->
                            <div style="text-align: center; padding: 20px; color: #6c757d;">Loading orders...</div>
                        </div>
                    </div>

                    <!-- PICKUPS FOR THE DAY -->
                    <div class="date-details-card">
                        <div class="details-card-header">
                            <h3><i class="fas fa-truck"></i> Pickups Due This Date</h3>
                            <span class="details-badge">0</span>
                        </div>
                        <div class="details-card-content">
                            <!-- Pickups will be dynamically loaded here -->
                            <div style="text-align: center; padding: 20px; color: #6c757d;">Loading pickups...</div>
                        </div>
                    </div>
                </div>
                <div class="date-details-actions">
                    <button class="action-btn primary" onclick="viewAllOrders()">
                        <i class="fas fa-list"></i> View All Orders
                    </button>
                    <button class="action-btn secondary" onclick="viewAllPickups()">
                        <i class="fas fa-truck"></i> View All Pickups
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SELF-SERVICE ORDERS MODAL -->
    <div id="selfServiceModal" class="calendar-modal">
        <div class="calendar-modal-content" style="max-width: 500px;">
            <div class="calendar-modal-header">
                <h2><i class="fas fa-user-cog"></i> Self-Service Orders</h2>
                <button class="modal-close-btn" onclick="closeSelfServiceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="calendar-modal-body">
                <div class="order-cards">
                    <div class="order-card pending">
                        <div class="order-card-header">
                            <div class="order-id">#ORD-101</div>
                            <div class="order-time">10:00 AM</div>
                        </div>
                        <div class="order-card-body">
                            <div class="customer-info">
                                <div class="customer-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="customer-details">
                                    <span class="customer-name">Alex</span>
                                    <span class="order-type-badge self-service">Self-service</span>
                                </div>
                            </div>
                            <div class="order-details">
                                <div class="order-items">
                                    <span class="item-count">2 items</span>
                                    <span class="order-value">₱100</span>
                                </div>
                                <div class="order-status-badge pending">Pending</div>
                            </div>
                        </div>
                    </div>
                    <div class="order-card pick-up">
                        <div class="order-card-header">
                            <div class="order-id">#ORD-102</div>
                            <div class="order-time">11:30 AM</div>
                        </div>
                        <div class="order-card-body">
                            <div class="customer-info">
                                <div class="customer-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="customer-details">
                                    <span class="customer-name">Jamie</span>
                                    <span class="order-type-badge self-service">Self-service</span>
                                </div>
                            </div>
                            <div class="order-details">
                                <div class="order-items">
                                    <span class="item-count">4 items</span>
                                    <span class="order-value">₱200</span>
                                </div>
                                <div class="order-status-badge pick-up">Pick-up</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CALENDAR JAVASCRIPT -->
    <script>

        // CALENDAR
        let currentDate = new Date();
        let selectedDate = new Date();
        let datesWithOrders = new Set();
        let datesWithPickups = new Set();
        const orderStatusCounts = JSON.parse('{{ order_status_counts|tojson|safe }}');
        const orderTrend = JSON.parse('{{ order_trend|tojson|safe }}');
    
        document.addEventListener('DOMContentLoaded', function() {
            loadCalendarDates();
            renderCalendar();
            renderOrderCharts();
        });
        
        // Load dates with orders and pickups from database
        function loadCalendarDates() {
            fetch('/api/calendar_dates')
                .then(response => response.json())
                .then(data => {
                    datesWithOrders = new Set(data.dates_with_orders || []);
                    datesWithPickups = new Set(data.dates_with_pickups || []);
                    renderCalendar(); // Re-render to mark dates
                })
                .catch(error => {
                    console.error('Error loading calendar dates:', error);
                });
        }
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = getMonthName(month);
            document.getElementById('currentYear').textContent = year;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                if (isToday(date)) {
                    dayElement.classList.add('today');
                }
                
                if (isSelected(date)) {
                    dayElement.classList.add('selected');
                }
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // Mark dates with orders or pickups
                const dateStr = formatDateForAPI(date);
                if (datesWithOrders.has(dateStr)) {
                    dayElement.classList.add('has-event');
                }
                if (datesWithPickups.has(dateStr)) {
                    dayElement.classList.add('has-pickup');
                }
                
                dayElement.addEventListener('click', function() {
                    if (!dayElement.classList.contains('other-month')) {
                        selectDate(date);
                        openDateDetailsModal(date); 
                    }
                });
                
                calendarDays.appendChild(dayElement);
            }
        }
        
        function getMonthName(month) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return months[month];
        }
        
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }
        
        function isSelected(date) {
            if (!selectedDate) return false;
            return date.getDate() === selectedDate.getDate() &&
                   date.getMonth() === selectedDate.getMonth() &&
                   date.getFullYear() === selectedDate.getFullYear();
        }
        
        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
        }
        
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            renderFullCalendar(); // Update full calendar if modal is open
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            renderFullCalendar(); // Update full calendar if modal is open
        }
        
        // Format date as YYYY-MM-DD for API
        function formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function toggleSidebar() {
            const sidebar = document.querySelector('.w3-sidebar');
            const main = document.querySelector('main');
            
            if (sidebar.style.display === 'none') {
                sidebar.style.display = 'block';
                main.style.marginLeft = '250px';
            } else {
                sidebar.style.display = 'none';
                main.style.marginLeft = '0';
            }
        }

        // CALENDAR MODAL
        function openCalendarModal() {
            document.getElementById('calendarModal').style.display = 'block';
            renderFullCalendar(); 
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').style.display = 'none';
        }

        function renderFullCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('fullCurrentMonth').textContent = getMonthName(month);
            document.getElementById('fullCurrentYear').textContent = year;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const fullCalendarDays = document.getElementById('fullCalendarDays');
            fullCalendarDays.innerHTML = '';

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day'; 
                dayElement.textContent = date.getDate();

                if (isToday(date)) {
                    dayElement.classList.add('today');
                }

                if (isSelected(date)) {
                    dayElement.classList.add('selected');
                }

                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // Mark dates with orders or pickups
                const dateStr = formatDateForAPI(date);
                if (datesWithOrders.has(dateStr)) {
                    dayElement.classList.add('has-event');
                }
                if (datesWithPickups.has(dateStr)) {
                    dayElement.classList.add('has-pickup');
                }

                dayElement.addEventListener('click', function() {
                    if (!dayElement.classList.contains('other-month')) {
                        selectDate(date); 
                        closeCalendarModal(); 
                        openDateDetailsModal(date); 
                    }
                });

                fullCalendarDays.appendChild(dayElement);
            }
        }

        // DATE DETAILS MODAL
        function openDateDetailsModal(date) {
            const modal = document.getElementById('dateDetailsModal');
            const selectedDateTitle = document.getElementById('selectedDateTitle');
            selectedDateTitle.textContent = date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            modal.style.display = 'block';
            
            // Load orders and pickups for this date
            loadDateDetails(date);
        }
        
        // Load orders and pickups for a specific date
        function loadDateDetails(date) {
            const dateStr = formatDateForAPI(date);
            
            // Load orders
            fetch(`/api/orders_by_date?date=${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    displayOrdersForDate(data.orders || []);
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    displayOrdersForDate([]);
                });
            
            // Load pickups
            fetch(`/api/pickups_by_date?date=${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    displayPickupsForDate(data.pickups || []);
                })
                .catch(error => {
                    console.error('Error loading pickups:', error);
                    displayPickupsForDate([]);
                });
        }
        
        // Display orders in the date details modal
        function displayOrdersForDate(orders) {
            const dateDetailsGrid = document.querySelector('#dateDetailsModal .date-details-grid');
            if (!dateDetailsGrid) return;
            
            // Find the orders card (first card in the grid)
            const ordersCard = dateDetailsGrid.querySelectorAll('.date-details-card')[0];
            if (!ordersCard) return;
            
            const ordersList = ordersCard.querySelector('.details-card-content');
            const ordersBadge = ordersCard.querySelector('.details-badge');
            
            if (ordersBadge) {
                ordersBadge.textContent = orders.length;
            }
            
            if (ordersList) {
                ordersList.innerHTML = '';
                
                if (orders.length === 0) {
                    ordersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">No orders for this date</div>';
                } else {
                    orders.forEach(order => {
                        const orderItem = document.createElement('div');
                        orderItem.className = 'order-detail-item';
                        
                        const orderStatus = (order.ORDER_STATUS || '').toLowerCase();
                        const statusClass = orderStatus === 'pending' ? 'pending' : 
                                          (orderStatus === 'pickup' || orderStatus === 'pick-up') ? 'pick-up' : 
                                          'completed';
                        const orderType = (order.ORDER_TYPE || '').toLowerCase();
                        const typeClass = orderType === 'self-service' ? 'self-service' : 'drop-off';
                        
                        orderItem.innerHTML = `
                            <div class="order-detail-info">
                                <span class="order-detail-number">#ORD-${String(order.ORDER_ID).padStart(3, '0')}</span>
                                <span class="order-detail-type ${typeClass}">${order.ORDER_TYPE || 'N/A'}</span>
                            </div>
                            <div class="order-detail-status ${statusClass}">${order.ORDER_STATUS || 'N/A'}</div>
                        `;
                        ordersList.appendChild(orderItem);
                    });
                }
            }
        }
        
        // Display pickups in the date details modal
        function displayPickupsForDate(pickups) {
            const dateDetailsGrid = document.querySelector('#dateDetailsModal .date-details-grid');
            if (!dateDetailsGrid) return;
            
            // Find the pickups card (second card in the grid)
            const pickupsCards = dateDetailsGrid.querySelectorAll('.date-details-card');
            if (pickupsCards.length < 2) return;
            
            const pickupsCard = pickupsCards[1];
            const pickupsList = pickupsCard.querySelector('.details-card-content');
            const pickupsBadge = pickupsCard.querySelector('.details-badge');
            
            if (pickupsBadge) {
                pickupsBadge.textContent = pickups.length;
            }
            
            if (pickupsList) {
                pickupsList.innerHTML = '';
                
                if (pickups.length === 0) {
                    pickupsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">No pickups scheduled for this date</div>';
                } else {
                    pickups.forEach((pickup, index) => {
                        const pickupItem = document.createElement('div');
                        pickupItem.className = 'pickup-detail-item';
                        
                        const orderStatus = (pickup.ORDER_STATUS || '').toLowerCase();
                        const statusClass = orderStatus === 'pending' ? 'pending' : 'ready';
                        
                        pickupItem.innerHTML = `
                            <div class="pickup-detail-info">
                                <span class="pickup-detail-number">#PICK-${String(pickup.ORDER_ID).padStart(3, '0')}</span>
                                <span class="pickup-detail-time">${pickup.PICKUP_TIME || 'N/A'}</span>
                            </div>
                            <div class="pickup-detail-status ${statusClass}">${pickup.ORDER_STATUS === 'Pending' ? 'Pending' : 'Ready'}</div>
                        `;
                        pickupsList.appendChild(pickupItem);
                    });
                }
            }
        }

        function closeDateDetailsModal() {
            document.getElementById('dateDetailsModal').style.display = 'none';
            // Reset selected date to null to remove highlight
            selectedDate = null;
            renderCalendar();
            renderFullCalendar(); // Update full calendar if modal is open
        }

        function viewAllOrders() {
            // Redirect to orders page with date filter
            if (!selectedDate) return;
            const dateStr = formatDateForAPI(selectedDate);
            window.location.href = `/orders?start_date=${dateStr}&end_date=${dateStr}`;
        }

        function viewAllPickups() {
            // Redirect to orders page with pickup filter
            if (!selectedDate) return;
            const dateStr = formatDateForAPI(selectedDate);
            window.location.href = `/orders?pickup_date=${dateStr}`;
        }
        
        function renderOrderCharts() {
            if (typeof Chart === 'undefined') return;
            
            // Status doughnut with background ring and center text
            const centerText = {
                id: 'centerText',
                afterDraw(chart) {
                    const opts = chart.config.options.plugins.centerText || {};
                    const { text = '', subText = '' } = opts;
                    if (!text) return;
                    const { ctx, chartArea } = chart;
                    if (!chartArea) return;
                    const x = (chartArea.left + chartArea.right) / 2;
                    const y = (chartArea.top + chartArea.bottom) / 2;
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#122D69';
                    ctx.font = '700 18px Poppins, sans-serif';
                    ctx.fillText(text, x, y - (subText ? 6 : 0));
                    if (subText) {
                        ctx.fillStyle = '#6c757d';
                        ctx.font = '600 12px Poppins, sans-serif';
                        ctx.fillText(subText, x, y + 12);
                    }
                    ctx.restore();
                }
            };

            const statusLabels = Object.keys(orderStatusCounts || {});
            const statusValues = Object.values(orderStatusCounts || {});
            const statusColors = ['#2fa35a', '#9aa5b5', '#f5c04e', '#4cb7d1'];
            const statusTotal = statusValues.reduce((a, b) => a + b, 0) || 1;
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [
                            {
                                data: [statusTotal],
                                backgroundColor: ['#e8edf5'],
                                borderWidth: 0,
                                hoverOffset: 0,
                                weight: 0.5,
                                cutout: '40%'
                            },
                            {
                                data: statusValues,
                                backgroundColor: statusColors,
                                borderWidth: 2,
                                borderColor: '#ffffff',
                                hoverOffset: 6,
                                spacing: 2,
                                weight: 1
                            }
                        ]
                    },
                    options: {
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                onHover: (evt) => { if (evt?.native?.target) evt.native.target.style.cursor = 'pointer'; },
                                onLeave: (evt) => { if (evt?.native?.target) evt.native.target.style.cursor = 'default'; },
                                labels: {
                                    usePointStyle: false,
                                    boxWidth: 18,
                                    boxHeight: 10,
                                    padding: 10,
                                    generateLabels(chart) {
                                        const labels = statusLabels;
                                        const colors = statusColors;
                                        const values = statusValues;
                                        return labels.map((label, i) => ({
                                            text: `${label} ${values[i] ?? 0}`,
                                            fillStyle: colors[i] || '#9aa5b5',
                                            strokeStyle: colors[i] || '#9aa5b5',
                                            lineWidth: 2,
                                            hidden: false,
                                            index: i
                                        }));
                                    }
                                }
                            },
                            centerText: { text: statusTotal.toString(), subText: 'Total' }
                        },
                        maintainAspectRatio: false,
                        cutout: '78%'
                    },
                    plugins: [centerText]
                });
            }

            // Trend bar (last 7 days)
            const trendLabels = (orderTrend && orderTrend.labels) || [];
            const trendValues = (orderTrend && orderTrend.counts) || [];
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx) {
                new Chart(trendCtx, {
                    type: 'bar',
                    data: {
                        labels: trendLabels,
                        datasets: [{
                            label: 'Orders',
                            data: trendValues,
                            backgroundColor: '#122D69',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                        plugins: { legend: { display: false } },
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        // INVENTORY
        function reorderInventory() {
            alert('Opening reorder form for inventory items');
        }
        
        function viewInventoryReport() {
            alert('Opening inventory report');
        }
        
        // SELF-SERVICE ORDERS
        function openSelfServiceModal() {
            document.getElementById('selfServiceModal').style.display = 'block';
        }

        function closeSelfServiceModal() {
            document.getElementById('selfServiceModal').style.display = 'none';
        }

        function toggleOrders() {
            const prioritySection = document.getElementById('priorityOrdersSection');
            const selfServiceSection = document.getElementById('selfServiceOrdersSection');
            const btnText = document.getElementById('toggleOrdersBtnText');
            const btnIcon = document.querySelector('#toggleOrdersBtn i.fas');
            if (prioritySection.style.display === 'none') {
                prioritySection.style.display = '';
                selfServiceSection.style.display = 'none';
                btnText.textContent = 'Self-Service Orders';
                btnIcon.className = 'fas fa-user-cog';
            } else {
                prioritySection.style.display = 'none';
                selfServiceSection.style.display = '';
                btnText.textContent = 'Priority Orders';
                btnIcon.className = 'fas fa-list';
            }
        }
    </script>
</body>
</html>