<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/staff_customers.css">
    <link rel="stylesheet" href="../static/css/w3.css">
    <link rel="icon" type="image/x-icon" href="../static/images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Inventory Management</title>
</head>
<body>
    <!-- CONTAINER -->
    <div class="container">
        <!-- SIDEBAR -->
        <aside class="w3-sidebar w3-bar-block w3-card-2 width" style="width:250px">
            <!-- LOGO -->
            <div class="w3-center w3-bar-item logo">
                <img src="../static/images/logo.jpg" alt="Logo" class="logo" style="width: 90px; height: 100px;">
            </div>
            
            <!-- MAIN TITLE (DASHBOARD)-->
            <div class="w3-margin w3-margin-top main-title">
                <img src="../static/images/dashboard.png" alt="Dashboard" class="nav-icon">
                <span>Dashboard</span>
            </div>
            
            <!-- MAIN NAVIGATION PERO SIDEBAR GIHAPON NA SUD HA **BASTA MAO NANA -->
            <nav class="w3-container w3-padding w3-margin-top">
                <!-- MAIN -->
                <div class="section-title w3-padding w3-text-gray">Main</div>
                <!-- DASHBOARD, DETERGENT, CONDITIONER, SCANNER -->
                <ul class="w3-margin-left">
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('dashboard') }}">
                            <span>Dashboard</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('detergent_inventory') }}">
                            <span>Detergent</span>
                        </a>      
                    </li>
                    
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('fabric_conditioner') }}">
                            <span>Fabric Conditioner</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('scanner') }}">
                            <span>Scanner</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button active">
                        <a href="{{ url_for('customers') }}">
                            <span>Customers</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('orders') }}">
                            <span>Orders</span>
                        </a>
                    </li>
                </ul>
                <!-- REPORTS -->
                <div class="section-title w3-padding w3-text-gray">Reports</div>
                <ul class="w3-margin-left">
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('admin_order_report')}}">
                            <span>Order Reports</span>
                        </a>
                    </li>

                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('inventory_report') }}">
                            <span>Inventory Reports</span>
                        </a>
                    </li>
                    
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="#">
                            <span>Sales Report</span>
                        </a>
                    </li>
                    
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('customer_report') }}">
                            <span>Transaction Reports</span>
                        </a>
                    </li>
                </ul>
                <!-- LOGOUT -->
                <ul class="w3-margin-left w3-margin-top">
                    <li class="w3-padding w3-bar-item w3-button">
                        <a href="{{ url_for('logout') }}">
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        
        <!-- MAIN -->
        <main>
            <!-- HEADER -->
            <header>
                <div>
                    <button class="w3-button w3-xlarge hamburger-btn" onclick="toggleSidebar()" title="Toggle Sidebar"><i class="fas fa-bars"></i></button>
                    <h1 class="page-title">Customers</h1>
                    <div class="breadcrumb">Main / Customers</div>
                </div>
            </header>

            <!-- CONTAINER FOR THE MAIN CONTENT -->
            <div class="w3-container w3-padding w3-margin">
                <!-- CUSTOMER STATISTICS CARDS -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Total Customers</h3>
                            <div class="stat-number">{{ stats.total_customers }}</div>
                            <div class="stat-detail">{{ '{:+.1f}'.format(stats.monthly_growth) }}% from last month</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Paid Orders</h3>
                            <div class="stat-number">{{ stats.paid_orders }}</div>
                            <div class="stat-detail">{{ stats.paid_percentage }}% of total</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Pending Orders</h3>
                            <div class="stat-number">{{ stats.pending_orders }}</div>
                            <div class="stat-detail">{{ stats.pending_percentage }}% of total</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Monthly Growth</h3>
                            <div class="stat-number">{{ '{:+.1f}%'.format(stats.monthly_growth) }}</div>
                            <div class="stat-detail">vs last month</div>
                        </div>
                    </div>
                </div>

                <!-- CHARTS -->
                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-pie"></i> Payment Status Distribution</h3>
                        </div>
                        <div class="chart-content">
                            <canvas id="paymentChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Customer Growth Trend</h3>
                        </div>
                        <div class="chart-content">
                            <canvas id="growthChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- ORDER TYPE, ORDER STATUS, FILTER AND SEARCH BOX -->
                <div class="search-row">
                    <form method="GET" action="{{ url_for('customers') }}" class="filter-form">
                        <div class="filter-group">
                            <label for="status-filter">Filter by Status:</label>
                            <select name="status" id="status-filter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="filter-btn">Apply Filter</button>
                    </form>
                    
                    <form method="GET" action="{{ url_for('customers') }}" class="search-container">
                        <input type="text" class="search-box" name="q" placeholder="Search..." value="{{ request.args.get('q', '') }}">
                        {% if request.args.get('q', '') %}
                        <a href="{{ url_for('customers') }}" class="clear-search-btn" title="Clear search">
                            <i class="fas fa-times-circle"></i>
                        </a>
                        {% endif %}
                        <button type="submit" class="search-icon" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>

                <!-- TABLE -->
                <div class="table-container">
                    <table class="customers-table">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Name</th>
                                <th>Phone Number</th>
                                <th>Payment Status</th>
                                <th>Order ID</th>
                                <th>Order Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                       <tbody>
                            {% for customer in customers %}
                            <tr>
                                <td>{{ customer.CUSTOMER_ID }}</td>
                                <td>{{ customer.FULLNAME }}</td>
                                <td>{{ customer.PHONE_NUMBER }}</td>
                                <td>
                                    <span class="status-badge status-{% if customer.PAYMENT_STATUS == 'PAID' %}paid{% else %}unpaid{% endif %}">
                                        {{ customer.PAYMENT_STATUS }}
                                    </span>
                                </td>
                                <td>{{ customer.ORDER_ID }}</td>
                                <td>
                                    <span class="status-badge status-{{ customer.ORDER_STATUS.lower() }}">
                                        {{ customer.ORDER_STATUS }}
                                    </span>
                                </td>
                                <td>
                                    <button class="edit-btn" onclick="openEditModal({{ customer.CUSTOMER_ID }})" title="Edit Customer">
                                        <i class="fas fa-edit"></i> 
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not customers %}
                            <tr>
                                <td colspan="7" class="text-center">No customers found</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <div class="pagination">
                        {% if current_page > 1 %}
                            <a href="{{ url_for('customers', page=current_page-1, status=request.args.get('status', ''), q=request.args.get('q', '')) }}" class="pagination-nav-btn">
                                <i class="fas fa-chevron-left"></i> Prev
                            </a>
                        {% else %}
                            <button class="pagination-nav-btn disabled" disabled>
                                <i class="fas fa-chevron-left"></i> Prev
                            </button>
                        {% endif %}
                        
                        <div class="pagination-numbers">
                            {% if total_pages > 0 %}
                                {% set group_size = 5 %}
                                {% set current_group = ((current_page - 1) // group_size) + 1 %}
                                {% set start_page = (current_group - 1) * group_size + 1 %}
                                {% set end_page = [start_page + group_size - 1, total_pages] | min %}
                                
                                {% for page_num in range(start_page, end_page + 1) %}
                                    {% if page_num == current_page %}
                                        <span class="page-btn active">{{ page_num }}</span>
                                    {% else %}
                                        <a href="{{ url_for('customers', page=page_num, status=request.args.get('status', ''), q=request.args.get('q', '')) }}" class="page-btn">{{ page_num }}</a>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        {% if current_page < total_pages %}
                            <a href="{{ url_for('customers', page=current_page+1, status=request.args.get('status', ''), q=request.args.get('q', '')) }}" class="pagination-nav-btn">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        {% else %}
                            <button class="pagination-nav-btn disabled" disabled>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main> 
    </div>
    
    <!-- Edit Customer Modal -->
    <div id="editCustomerModal" class="w3-modal">
        <div class="w3-modal-content">
            <header>
                <h2><i class="fas fa-edit"></i> Edit Customer</h2>
                <span onclick="closeEditModal()" class="w3-display-topright">&times;</span>
            </header>
            <div class="w3-container">
                <form id="editCustomerForm" method="POST" action="{{ url_for('edit_customer') }}">
                    <input type="hidden" id="edit_customer_id" name="customer_id">
                    <div class="w3-margin-bottom" style="margin-top: 15px;">
                        <label for="edit_fullname">Full Name</label>
                        <input class="w3-input w3-border" type="text" id="edit_fullname" name="fullname" placeholder="Enter full name" required>
                    </div>
                    <div class="w3-margin-bottom">
                        <label for="edit_phone_number">Phone Number</label>
                        <input class="w3-input w3-border" type="text" id="edit_phone_number" name="phone_number" placeholder="Enter phone number">
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="w3-button w3-red" onclick="closeEditModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="w3-button w3-blue">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // PAYMENT STATUS DISTRIBUTION CHART
        const paymentCtx = document.getElementById('paymentChart').getContext('2d');
        const paymentData = {
            paid: {{ stats.paid_percentage|default(0) }},
            unpaid: {{ stats.unpaid_percentage|default(0) }}
        };
        
        const paymentChart = new Chart(paymentCtx, {
            type: 'doughnut',
            data: {
                labels: ['Paid', 'Unpaid'],
                datasets: [{
                    data: [paymentData.paid, paymentData.unpaid],
                    backgroundColor: [
                        '#77dd77',  // Light green for paid
                        '#ff6961'   // Light red for unpaid
                    ],
                    borderColor: [
                        '#28a745',  // Darker green border
                        '#dc3545'   // Darker red border
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}%`;
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                family: 'Poppins',
                                size: 12
                            }
                        }
                    }
                }
            }
        });

        // CUSTOMER GROWTH TREND CHART
        const growthCtx = document.getElementById('growthChart').getContext('2d');
        const growthChart = new Chart(growthCtx, {
            type: 'line',
            data: {
                labels: {{ stats.monthly_data.months|tojson }},
                datasets: [{
                    label: 'New Customers',
                    data: {{ stats.monthly_data.counts|tojson }},
                    borderColor: '#122D69',
                    backgroundColor: 'rgba(18, 45, 105, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 12
                            }
                        }
                    }
                }
            }
        });

        // Edit Customer Modal Functions
        function openEditModal(customerId) {
            // Fetch customer data
            fetch(`/get_customer/${customerId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    document.getElementById('edit_customer_id').value = data.CUSTOMER_ID;
                    document.getElementById('edit_fullname').value = data.FULLNAME || '';
                    document.getElementById('edit_phone_number').value = data.PHONE_NUMBER || '';
                    document.getElementById('editCustomerModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load customer data');
                });
        }

        function closeEditModal() {
            document.getElementById('editCustomerModal').style.display = 'none';
            document.getElementById('editCustomerForm').reset();
        }

        // Handle form submission
        document.getElementById('editCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/edit_customer', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Customer updated successfully!');
                    closeEditModal();
                    // Reload the page to show updated data
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update customer'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update customer');
            });
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editCustomerModal');
            if (event.target == modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>