<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/super_admin_shops.css">
    <link rel="stylesheet" href="../static/css/w3.css">
    <link rel="icon" type="image/x-icon" href="../static/images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="../static/css/super_admin_reports.css">
    <title>Reports</title>
</head>

<body>
    <!-- CONTAINER -->
    <div class="container">
        <!-- SIDEBAR -->
        <aside class="w3-sidebar w3-bar-block w3-card-2 width" style="width:250px">
            <!-- LOGO -->
            <div class="w3-center w3-bar-item logo">
                <img src="../static/images/logo.jpg" alt="Logo" class="logo" style="width: 90px; height: 100px;">
            </div>

            <!-- MAIN TITLE (DASHBOARD)-->
            <div class="w3-margin w3-margin-top main-title">
                <img src="../static/images/dashboard.png" alt="Dashboard" class="nav-icon">
                <span>LAUNDRYLINK</span>
            </div>

            <!-- MAIN NAVIGATION -->
            <div class="w3-bar-block">
                <a href="{{ url_for('super_admin_dashboard') }}" class="w3-bar-item w3-button w3-padding"><i
                        class="fa fa-tachometer-alt fa-fw"></i> Dashboard</a>
                <a href="{{ url_for('laundry_shops') }}" class="w3-bar-item w3-button w3-padding"><i
                        class="fa fa-store fa-fw"></i> Laundry Shops</a>
                <a href="{{ url_for('device_monitoring') }}" class="w3-bar-item w3-button w3-padding"><i
                        class="fa fa-microchip fa-fw"></i> Devices
                    Monitoring</a>
                <a href="{{ url_for('super_admin_reports') }}" class="w3-bar-item w3-button w3-padding active"><i
                        class="fa fa-chart-line fa-fw"></i> Reports &
                    Analytics</a>
                <div class="logout-btn">
                    <a href="{{ url_for('logout') }}" class="w3-bar-item w3-button w3-padding"><i
                            class="fa fa-sign-out-alt fa-fw"></i> Logout</a>
                </div>
            </div>
        </aside>

        <!-- MAIN -->
        <main>
            <!-- HEADER -->
            <header>
                <div>
                    <h1 class="page-title">Reports & Analytics</h1>
                    <div class="breadcrumb">Main / Reports & Analytics</div>
                </div>

            </header>

            <br>
            <!-- FILTERS SECTION -->
            <section class="filters-section">
                <div class="filter-container">
                    <div class="filter-group">
                        <label for="dateRange"><i class="fas fa-calendar-alt"></i> Date Range</label>
                        <select id="dateRange" class="filter-select">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="last7">Last 7 Days</option>
                            <option value="last30">Last 30 Days</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>

                    <div class="filter-group custom-date hidden">
                        <label for="startDate">From</label>
                        <input type="date" id="startDate" class="filter-input">
                    </div>

                    <div class="filter-group custom-date hidden">
                        <label for="endDate">To</label>
                        <input type="date" id="endDate" class="filter-input">
                    </div>

                    <div class="filter-group">
                        <label for="shopFilter"><i class="fas fa-store"></i> Shop</label>
                        <select id="shopFilter" class="filter-select">
                            <option value="all">All Shops</option>
                            <option value="shop1">City Center Branch</option>
                            <option value="shop2">Mall of Asia Branch</option>
                            <option value="shop3">Quezon City Branch</option>
                            <option value="shop4">Makati Branch</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="reportType"><i class="fas fa-chart-bar"></i> Report Type</label>
                        <select id="reportType" class="filter-select">
                            <option value="all">All Reports</option>
                            <option value="transaction">Transaction Reports</option>
                            <option value="device">Device Uptime Reports</option>
                            <option value="performance">Shop Performance Reports</option>
                        </select>
                    </div>

                    <button class="apply-btn" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    <button class="reset-btn" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </section>

            <!-- SUMMARY CARDS -->
            <section class="summary-cards">
                <div class="card">
                    <div class="card-icon revenue">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="card-content">
                        <h3>Total Revenue</h3>
                        <p class="card-value">₱{{ "%.2f"|format(stats.total_revenue) }}</p>
                        <p class="card-change positive">Total Revenue</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-icon transactions">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="card-content">
                        <h3>Total Transactions</h3>
                        <p class="card-value">{{ stats.total_transactions }}</p>
                        <p class="card-change positive">Total Orders</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-icon uptime">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="card-content">
                        <h3>Device Uptime</h3>
                        <p class="card-value">{{ stats.uptime_percentage }}%</p>
                        <p class="card-change positive">Average Uptime</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-icon shops">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="card-content">
                        <h3>Active Shops</h3>
                        <p class="card-value">{{ stats.active_shops_count }}/{{ stats.installed_shops_count }}</p>
                        <p class="card-change neutral">Active / Installed</p>
                    </div>
                </div>
            </section>

            <!-- REPORTS SECTIONS -->
            <section class="reports-section">

                <!-- 1️⃣ INSTALLATION & DEPLOYMENT OVERVIEW -->
                <div class="report-card">
                    <div class="report-header">
                        <h2><i class="fas fa-tools"></i> Installation & Deployment Overview</h2>
                        <div class="report-actions">
                            <button class="action-btn" onclick="exportInstallationPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="action-btn" onclick="exportInstallationCSV()">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                    <div class="report-content">
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h3 class="chart-title">Devices Installed per Shop</h3>
                                <canvas id="installationDevicesChart" style="width:100%;height:100%;"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3 class="chart-title">Installation Revenue Distribution</h3>
                                <canvas id="installationRevenueChart" style="width:100%;height:100%;"></canvas>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Laundry Shop Name</th>
                                        <th>Number of Devices</th>
                                        <th>Installation Fee (per Shop)</th>
                                        <th>Total Installation Fee</th>
                                        <th>Installation Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in stats.installation_data %}
                                    <tr>
                                        <td>{{ row.shop_name }}</td>
                                        <td>{{ row.device_count }}</td>
                                        <td>₱{{ "{:,.0f}".format(row.fee_per_shop) }}</td>
                                        <td>₱{{ "{:,.0f}".format(row.total_fee) }}</td>
                                        <td>{{ row.date_installed }}</td>
                                        <td><span class="status-badge success">{{ row.status }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- 3️⃣ DEVICE UPTIME & MONITORING REPORTS -->
                <div class="report-card">
                    <div class="report-header">
                        <h2><i class="fas fa-microchip"></i> Device Uptime & Monitoring Reports</h2>
                        <div class="report-actions">
                            <button class="action-btn" onclick="exportUptimePDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="action-btn" onclick="exportUptimeCSV()">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                    <div class="report-content">
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h3 class="chart-title">Device Uptime Comparison</h3>
                                <canvas id="uptimeChart" style="width:100%;height:100%;"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3 class="chart-title">Device Status Distribution</h3>
                                <canvas id="deviceStatusChart" style="width:100%;height:100%;"></canvas>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Device ID</th>
                                        <th>Shop</th>
                                        <th>Online/Offline Status</th>
                                        <th>Uptime %</th>
                                        <th>Last Online</th>
                                        <th>Error Logs</th>
                                        <th>Reliability</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for shop in shops %}
                                    <tr>
                                        <td>DEV-{{ '%03d'|format(shop.SHOP_ID) }}</td>
                                        <td>{{ shop.SHOP_NAME }}</td>
                                        <td>
                                            {% if shop.weighing_scale.status == 'online' %}
                                            <span class="status-badge success">Online</span>
                                            {% else %}
                                            <span class="status-badge error">Offline</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ stats.uptime_percentage }}%</td>
                                        <td>{{ shop.weighing_scale.last_seen }}</td>
                                        <td>N/A</td>
                                        <td><span class="performance-badge good">Good</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </section>
        </main>
    </div>

    <script src="../static/js/super_admin_reports.js"></script>
    </main>
    </div>

    <!-- jsPDF and SheetJS for export functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // Chart initialization - Dynamic Data Injection
        const shopLabels = {{ stats.installation_data | map(attribute = 'shop_name') | list | tojson }};
        const deviceCounts = {{ stats.installation_data | map(attribute = 'device_count') | list | tojson }};
        const revenueData = {{ stats.installation_data | map(attribute = 'total_fee') | list | tojson }};

        document.addEventListener('DOMContentLoaded', function () {
            // Installation & Deployment - Devices per Shop Chart
            const installationDevicesCtx = document.getElementById('installationDevicesChart');
            if (installationDevicesCtx) {
                new Chart(installationDevicesCtx, {
                    type: 'bar',
                    data: {
                        labels: shopLabels,
                        datasets: [{
                            label: 'Number of Devices Installed',
                            data: deviceCounts,
                            backgroundColor: '#122D69',
                            borderRadius: 6,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }

            // Installation & Deployment - Revenue Distribution Chart
            const installationRevenueCtx = document.getElementById('installationRevenueChart');
            if (installationRevenueCtx) {
                new Chart(installationRevenueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: shopLabels,
                        datasets: [{
                            data: revenueData,
                            backgroundColor: [
                                '#122D69', '#2fa35a', '#f5c04e', '#dc3545', '#4cb7d1', '#6c757d'
                            ],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 20, font: { size: 13 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return '₱' + context.parsed.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Device Uptime - Uptime Comparison Chart
            const uptimeCtx = document.getElementById('uptimeChart');
            if (uptimeCtx) {
                const deviceLabels = {{ stats.device_labels | tojson }};
                const deviceUptimes = {{ stats.device_uptime_percentages | tojson }};

                
                // Color code based on uptime percentage
                const uptimeColors = deviceUptimes.map(function (uptime) {
            if (uptime >= 98) return '#2fa35a'; // Green for high uptime
            if (uptime >= 90) return '#f5c04e'; // Yellow for medium uptime
            return '#dc3545'; // Red for low uptime
        });

                new Chart(uptimeCtx, {
            type: 'bar',
            data: {
                labels: deviceLabels,
                datasets: [{
                    label: 'Uptime Percentage (%)',
                    data: deviceUptimes,
                    backgroundColor: uptimeColors,
                    borderRadius: 6,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.parsed.x.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
            }

        // Device Status Distribution Chart
        const deviceStatusCtx = document.getElementById('deviceStatusChart');
        if (deviceStatusCtx) {
                const statusDistribution = {{ stats.device_status_distribution | tojson }};


                new Chart(deviceStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Online', 'Warning', 'Offline'],
                datasets: [{
                    data: [
                        statusDistribution.online || 0,
                        statusDistribution.warning || 0,
                        statusDistribution.offline || 0
                    ],
                    backgroundColor: [
                        '#2fa35a',
                        '#f5c04e',
                        '#dc3545'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 13
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.label + ': ' + context.parsed + ' device(s)';
                            }
                        }
                    }
                }
            }
        });
            }

        // Date filter handling
        const dateRangeSelect = document.getElementById('dateRange');
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', function () {
                const customDates = document.querySelectorAll('.custom-date');
                if (this.value === 'custom') {
                    customDates.forEach(el => el.classList.remove('hidden'));
                } else {
                    customDates.forEach(el => el.classList.add('hidden'));
                }
            });
        }
        });

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('LaundryLink - Reports & Analytics', 14, 16);
            doc.autoTable({
                html: '.report-table',
                startY: 22,
                styles: { font: 'poppins', fontSize: 8 },
                headStyles: { fillColor: [18, 45, 105] },
                theme: 'grid',
            });
            doc.save('laundrylink-reports.pdf');
        }

        // Export Installation & Deployment PDF
        function exportInstallationPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Installation & Deployment Overview', 14, 16);
            doc.autoTable({
                html: '.report-card:nth-of-type(1) .report-table',
                startY: 22,
                styles: { font: 'poppins', fontSize: 8 },
                headStyles: { fillColor: [18, 45, 105] },
                theme: 'grid',
            });
            doc.save('installation-deployment.pdf');
        }

        // Export Installation & Deployment CSV
        function exportInstallationCSV() {
            exportTableToCSV('installation-deployment.csv', '.report-card:nth-of-type(1) .report-table');
        }

        // Export Device Uptime PDF
        function exportUptimePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Device Uptime & Monitoring Reports', 14, 16);
            doc.autoTable({
                html: '.report-card:nth-of-type(2) .report-table',
                startY: 22,
                styles: { font: 'poppins', fontSize: 8 },
                headStyles: { fillColor: [18, 45, 105] },
                theme: 'grid',
            });
            doc.save('device-uptime-reports.pdf');
        }

        // Export Device Uptime CSV
        function exportUptimeCSV() {
            exportTableToCSV('device-uptime-reports.csv', '.report-card:nth-of-type(2) .report-table');
        }

        // Generic CSV export function
        function exportTableToCSV(filename, tableSelector) {
            const table = document.querySelector(tableSelector);
            if (!table) return;
            const wb = XLSX.utils.table_to_book(table, { sheet: 'Report' });
            XLSX.writeFile(wb, filename);
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.w3-sidebar');
            sidebar.classList.toggle('active');
        }

        // Filter functions
        function applyFilters() {
            const shopFilter = document.getElementById('shopFilter').value;
            const dateRange = document.getElementById('dateRange').value;
            const reportType = document.getElementById('reportType').value;

            alert(`Filters applied:\nShop: ${shopFilter}\nDate Range: ${dateRange}\nReport Type: ${reportType}`);
        }

        function resetFilters() {
            document.getElementById('shopFilter').value = 'all';
            document.getElementById('dateRange').value = 'today';
            document.getElementById('reportType').value = 'all';
            document.querySelectorAll('.custom-date').forEach(el => el.classList.add('hidden'));
            alert('Filters have been reset');
        }

        // Responsive adjustments
        window.addEventListener('resize', function () {
            const sidebar = document.querySelector('.w3-sidebar');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>

</html>