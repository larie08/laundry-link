<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Baloo&display=swap" rel="stylesheet" />
        <link rel="icon" type="image/x-icon" href="../static/images/favicon.png">
        <link href="{{ url_for('static', filename='css/weight.css') }}" rel="stylesheet" />
        <title>Laundrylink - Weight Laundry</title>
        <style>
            .stable-weight {
                background-color: #e8f5e9 !important;  /* Light green background */
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="v93_70">
            <!-- Progress bar -->
            <div class="v93_72">
                <div class="v93_73"></div>
                <div class="v93_74"></div>
                <div class="v93_75"></div>
                <div class="v93_76"></div>
                <div class="v93_77"></div>
                <div class="v93_109"></div>
                <div class="v96_2"></div>
                <span class="v96_4">2</span>
            </div>
            
            <!-- Step labels below progress bar -->
            <span class="v93_78">YOU</span>
            <span class="v93_79">WEIGH</span>
            <span class="v93_80">OTHER</span>
            <span class="v93_81">PAYMENT</span>
            
            <!-- Main content container -->
            <div class="v93_144">
                    <div class="v95_13"></div>
                    <!-- Weight input form -->
                    <form method="POST" action="{{ url_for('weight_laundry') }}" id="weightForm">
                        <div class="weight-info">
                            <input type="number" id="weight_input" class="v95_24" name="weight" min="0" step="0.01" placeholder="Waiting for weight (kg)..." required readonly>
                            <input type="text" id="total_load" class="v95_36" name="total_load" placeholder="Total load (auto)" readonly>
                        </div>
                        <div class="button-container">
                            <a href="{{ url_for('contact') }}" class="v103_9" style="text-decoration: none;">
                                <span class="v103_10">Previous</span>
                            </a>
                            <button type="submit" class="v103_7" style="text-decoration: none;">
                                <span class="v103_8">Next</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        
        <!-- Error Modal
        <div id="errorModal" class="error-modal">
            <div class="error-content">
                <div class="error-icon"></div>
                <div class="error-title"><b>Weight Required</b></div>
                <div class="error-message">Please wait for the weight to be detected before proceeding to the next step.</div>
                <button class="error-button" onclick="closeErrorModal()">Got it</button>
            </div>
        </div> -->
        
        <script>
            // // Show error modal
            // function showErrorModal() {
            //     document.getElementById('errorModal').classList.add('show');
            // }
            
            // // Close error modal
            // function closeErrorModal() {
            //     document.getElementById('errorModal').classList.remove('show');
            // }
            
            // // Close modal when clicking outside
            // document.getElementById('errorModal').addEventListener('click', function(e) {
            //     if (e.target === this) {
            //         closeErrorModal();
            //     }
            // });
            
            // // Form validation before submit
            // document.getElementById('weightForm').addEventListener('submit', function(e) {
            //     const weightInput = document.getElementById('weight_input').value.trim();
                
            //     if (!weightInput || parseFloat(weightInput) <= 0) {
            //         e.preventDefault();
            //         showErrorModal();
            //         return false;
            //     }
            // });

            // Poll the backend for latest weight every second
            function pollWeight() {
                fetch('/get_latest_weight')
                    .then(response => response.json())
                    .then(data => {
                        const weight = parseFloat(data.weight) || 0;
                        const weightInput = document.getElementById('weight_input');
                        
                        // Format weight with 2 decimal places if > 0
                        weightInput.value = weight > 0 ? weight.toFixed(2) : '';
                        
                        // Calculate total load (1 load = 8kg)
                        const totalLoad = weight > 0 ? Math.ceil(weight / 8) : 0;
                        document.getElementById('total_load').value = totalLoad;
                        
                        // Highlight stable weight with different style
                        weightInput.classList.toggle('stable-weight', data.is_stable);
                    });
            }
            setInterval(pollWeight, 1000);
            pollWeight();

            // Heartbeat to tell backend page is active
            function setWeightPageActive(active) {
                fetch('/weight_page_active', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({active: active})
                });
            }
            setWeightPageActive(true);
            var heartbeat = setInterval(() => setWeightPageActive(true), 2000);

            // On page unload, set active to false
            window.addEventListener('beforeunload', function() {
                setWeightPageActive(false);
                clearInterval(heartbeat);
            });
        </script>
    </body>
</html>