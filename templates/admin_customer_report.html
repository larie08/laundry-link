<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/admin_customer_report.css">
    <link rel="stylesheet" href="../static/css/w3.css">
    <link rel="icon" type="image/x-icon" href="../static/images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Transaction Report</title>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <aside class="w3-sidebar w3-bar-block w3-card-2 width" style="width:250px">
            <div class="w3-center w3-bar-item logo">
                <img src="../static/images/logo.jpg" alt="Logo" class="logo" style="width: 90px; height: 100px;">
            </div>
            <div class="w3-margin w3-margin-top main-title">
                <img src="../static/images/dashboard.png" alt="Dashboard" class="nav-icon">
                <span>Dashboard</span>
            </div>
            <nav class="w3-container w3-padding w3-margin-top">
                <div class="section-title w3-padding w3-text-gray">Main</div>
                <ul class="w3-margin-left">
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('dashboard') }}"><span>Dashboard</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('detergent_inventory') }}"><span>Detergent</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('fabric_conditioner') }}"><span>Fabric Conditioner</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('scanner') }}"><span>Scanner</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('customers') }}"><span>Customers</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('orders') }}"><span>Orders</span></a></li>
                </ul>
                <div class="section-title w3-padding w3-text-gray">Reports</div>
                <ul class="w3-margin-left">
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('admin_order_report')}}"><span>Order Reports</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('inventory_report') }}"><span>Inventory Reports</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('income_statement') }}"><span>Sales Report</span></a></li>
                    <li class="w3-padding w3-bar-item w3-button active"><a href="{{ url_for('customer_report') }}"><span>Transaction Reports</span></a></li>
                </ul>
                <ul class="w3-margin-left w3-margin-top">
                    <li class="w3-padding w3-bar-item w3-button"><a href="{{ url_for('logout') }}"><span>Logout</span></a></li>
                </ul>
            </nav>
        </aside>
        <!-- MAIN -->
        <main>
            <header>
                <div>
                    <button class="w3-button w3-xlarge hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <h1 class="page-title">Transaction Report</h1>
                    <div class="breadcrumb">Main / Transaction Report</div>
                </div>
            </header>
            <div class="w3-container w3-padding w3-margin">
                <!-- SUMMARY CARDS -->
                <div class="stats-cards stats-cards-layout">
                    <div class="stat-card stat-card-layout">
                        <div class="stat-card-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-card-title">Total Customers</div>
                        <div class="stat-card-number">{{ total_customers if total_customers is not none else 0 }}</div>
                    </div>
                    <div class="stat-card stat-card-layout">
                        <div class="stat-card-icon"><i class="fas fa-user-plus"></i></div>
                        <div class="stat-card-title">New Customers (30d)</div>
                        <div class="stat-card-number">{{ new_customers_count if new_customers_count is not none else 0 }}</div>
                    </div>
                    <div class="stat-card stat-card-layout">
                        <div class="stat-card-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-card-title">Total Orders</div>
                        <div class="stat-card-number">{{ total_orders if total_orders is not none else 0 }}</div>
                    </div>
                    <div class="stat-card stat-card-layout">
                        <div class="stat-card-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-card-title">Customer Monthly Growth</div>
                        <div class="stat-card-number">
                            {{ customer_monthly_growth if customer_monthly_growth is not none else 0 }}%
                        </div>
                    </div>
                </div>
                <!-- FILTER/SEARCH SECTION (copied and adapted from admin_order_report.html) -->
                <!-- FILTER/SEARCH (match Order Report layout) -->
                <form class="filter-search-row card flex-row align-center" method="GET" action="{{ url_for('customer_report') }}">
                    <div class="search-container search-form-self-service" style="width:350px; display:flex;">
                        <input type="text" class="search-box" name="q" placeholder="Search customers by name or ID..." value="{{ request.args.get('q', '') }}">
                        <button type="submit" class="search-icon"><i class="fas fa-search"></i></button>
                        {% if request.args.get('q', '') %}
                        <a href="{{ url_for('customer_report') }}" class="clear-search-btn" title="Clear search">
                            <i class="fas fa-times-circle"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="date-filter flex-row align-center">
                        <div class="date-label">Filter by Period:</div>
                        <select id="periodFilter" class="w3-input w3-border" style="width: 150px; border-radius: 6px;">
                            <option value="">All Time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                        <button id="applyPeriodFilter" type="button" class="w3-button w3-blue-gray rounded-btn filter-btn" style="border-radius: 6px;">Apply</button>
                        <button id="clearPeriodFilter" type="button" class="w3-button w3-light-gray rounded-btn filter-btn" style="border-radius: 6px;">Clear</button>
                        <input type="hidden" name="date_from" id="hiddenDateFrom" value="{{ request.args.get('date_from', '') }}">
                        <input type="hidden" name="date_to" id="hiddenDateTo" value="{{ request.args.get('date_to', '') }}">
                    </div>
                </form>
                <div class="table-container">
                    <div class="table-header">
                        <h3>Transaction List</h3>
                        <div class="download-btns" style="display: flex; gap: 10px; margin-top: 10px;">
                            <a href="{{ url_for('download_customer_report', format='excel') }}?q={{ request.args.get('q', '') }}&date_from={{ request.args.get('date_from', '') }}&date_to={{ request.args.get('date_to', '') }}" class="w3-button w3-green rounded-btn"><i class="fas fa-file-excel"></i> Excel</a>
                            <a href="{{ url_for('download_customer_report', format='csv') }}?q={{ request.args.get('q', '') }}&date_from={{ request.args.get('date_from', '') }}&date_to={{ request.args.get('date_to', '') }}" class="w3-button w3-blue rounded-btn"><i class="fas fa-file-csv"></i> CSV</a>
                            <a href="{{ url_for('download_customer_report', format='pdf') }}?q={{ request.args.get('q', '') }}&date_from={{ request.args.get('date_from', '') }}&date_to={{ request.args.get('date_to', '') }}" class="w3-button w3-red rounded-btn"><i class="fas fa-file-pdf"></i> PDF</a>
                        </div>
                    </div>
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Customer Name</th>
                                <th>Phone Number</th>
                                <th>Order ID</th>
                                <th>Order Type</th>
                                <th>Order Status</th>
                                <th>Payment Status</th>
                                <th>Total Price</th>
                                <th>Date Created</th>
                                <th>Date Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>{{ transaction.CUSTOMER_ID }}</td>
                                <td>{{ transaction.CUSTOMER_NAME }}</td>
                                <td>{{ transaction.PHONE_NUMBER }}</td>
                                <td>{{ transaction.ORDER_ID }}</td>
                                <td>{{ transaction.ORDER_TYPE }}</td>
                                <td>{{ transaction.ORDER_STATUS }}</td>
                                <td>
                                    {% if transaction.PAYMENT_STATUS == 'Paid' or transaction.PAYMENT_STATUS == 'PAID' %}
                                    <span class="status-badge paid">Paid</span>
                                    {% elif transaction.PAYMENT_STATUS == 'Unpaid' or transaction.PAYMENT_STATUS == 'UNPAID' %}
                                    <span class="status-badge unpaid">Unpaid</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>{{ transaction.TOTAL_PRICE }}</td>
                                <td>{% if transaction.DATE_CREATED %}{{ transaction.DATE_CREATED|datetimeformat }}{% else %}N/A{% endif %}</td>
                                <td>{% if transaction.DATE_UPDATED %}{{ transaction.DATE_UPDATED|datetimeformat }}{% else %}N/A{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div style="display: flex; justify-content: flex-end; padding: 20px; background: #f9f9f9; border-top: 2px solid #ddd;">
                        <div style="font-weight: 600; font-size: 1.1rem;">
                            Total Revenue for Page: <span style="color: #233872;">â‚±{{ "%.2f"|format(transactions|map(attribute='TOTAL_PRICE')|map('float')|sum) }}</span>
                        </div>
                    </div>
                </div>
                <!-- PAGINATION BUTTONS -->
                <div class="pagination">
                    {% if current_page > 1 %}
                        <a href="{{ url_for('customer_report', page=current_page-1, q=request.args.get('q', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', '')) }}" class="pagination-nav-btn">
                            <i class="fas fa-chevron-left"></i> Prev
                        </a>
                    {% else %}
                        <button class="pagination-nav-btn disabled" disabled>
                            <i class="fas fa-chevron-left"></i> Prev
                        </button>
                    {% endif %}
                    <div class="pagination-numbers">
                        {% if total_pages > 0 %}
                            {% set group_size = 5 %}
                            {% set current_group = ((current_page - 1) // group_size) + 1 %}
                            {% set start_page = (current_group - 1) * group_size + 1 %}
                            {% set end_page = [start_page + group_size - 1, total_pages] | min %}
                            {% for page_num in range(start_page, end_page + 1) %}
                                {% if page_num == current_page %}
                                    <span class="page-btn active">{{ page_num }}</span>
                                {% else %}
                                    <a href="{{ url_for('customer_report', page=page_num, q=request.args.get('q', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', '')) }}" class="page-btn">{{ page_num }}</a>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% if current_page < total_pages %}
                        <a href="{{ url_for('customer_report', page=current_page+1, q=request.args.get('q', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', '')) }}" class="pagination-nav-btn">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    {% else %}
                        <button class="pagination-nav-btn disabled" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
    <script>
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('collapsed');
            document.querySelector('main').classList.toggle('expanded');
        };

        // Period filter (match Order Report behaviour)
        document.addEventListener('DOMContentLoaded', function() {
            const periodSelect = document.getElementById('periodFilter');
            const applyBtn = document.getElementById('applyPeriodFilter');
            const clearBtn = document.getElementById('clearPeriodFilter');
            const hiddenFrom = document.getElementById('hiddenDateFrom');
            const hiddenTo = document.getElementById('hiddenDateTo');
            const searchBox = document.querySelector('input[name="q"]');

            const fmt = (d) => d.toISOString().split('T')[0];

            function setSelectFromParams() {
                const from = hiddenFrom.value;
                const to = hiddenTo.value;
                if (!from || !to) {
                    periodSelect.value = 'daily';  // Default to daily
                    return;
                }
                const today = new Date();
                const todayStr = fmt(today);

                if (from === todayStr && to === todayStr) {
                    periodSelect.value = 'daily';
                    return;
                }

                const startMonth = fmt(new Date(today.getFullYear(), today.getMonth(), 1));
                const endMonth = fmt(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                if (from === startMonth && to === endMonth) {
                    periodSelect.value = 'monthly';
                    return;
                }

                const startYear = fmt(new Date(today.getFullYear(), 0, 1));
                const endYear = fmt(new Date(today.getFullYear(), 11, 31));
                if (from === startYear && to === endYear) {
                    periodSelect.value = 'yearly';
                    return;
                }

                // Weekly (Mon-Sun)
                const day = today.getDay(); // 0=Sun
                const monday = new Date(today);
                monday.setDate(today.getDate() - ((day + 6) % 7));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                if (from === fmt(monday) && to === fmt(sunday)) {
                    periodSelect.value = 'weekly';
                    return;
                }

                periodSelect.value = 'daily';  // Default to daily if can't match
            }

            function buildRange(period) {
                const now = new Date();
                if (!period || period === '') {
                    // Default to daily (today)
                    const d = fmt(now);
                    return { from: d, to: d };
                }
                if (period === 'daily') {
                    const d = fmt(now);
                    return { from: d, to: d };
                }
                if (period === 'weekly') {
                    const day = now.getDay(); // 0=Sun
                    const monday = new Date(now);
                    monday.setDate(now.getDate() - ((day + 6) % 7));
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);
                    return { from: fmt(monday), to: fmt(sunday) };
                }
                if (period === 'monthly') {
                    const start = new Date(now.getFullYear(), now.getMonth(), 1);
                    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    return { from: fmt(start), to: fmt(end) };
                }
                if (period === 'yearly') {
                    const start = new Date(now.getFullYear(), 0, 1);
                    const end = new Date(now.getFullYear(), 11, 31);
                    return { from: fmt(start), to: fmt(end) };
                }
                // Default to today
                const d = fmt(now);
                return { from: d, to: d };
            }

            function applyFilters() {
                const period = periodSelect.value;
                const { from, to } = buildRange(period);
                hiddenFrom.value = from;
                hiddenTo.value = to;
                // Reset to first page on new filter
                const form = periodSelect.closest('form');
                if (form) {
                    form.submit();
                }
            }

            applyBtn.addEventListener('click', applyFilters);

            clearBtn.addEventListener('click', function() {
                // Reset to daily (today)
                const now = new Date();
                const todayStr = fmt(now);
                hiddenFrom.value = todayStr;
                hiddenTo.value = todayStr;
                periodSelect.value = 'daily';
                if (searchBox) searchBox.value = '';
                const url = new URL(window.location);
                url.searchParams.set('date_from', todayStr);
                url.searchParams.set('date_to', todayStr);
                url.searchParams.delete('q');
                url.searchParams.delete('page');
                window.location.href = url;
            });

            // Set select state on load based on existing date_from/date_to
            setSelectFromParams();
        });
    </script>
</body>
</html>